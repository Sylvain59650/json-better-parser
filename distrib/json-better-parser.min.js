(function(global,factory){if(typeof define==="function"&&define.amd){define(["exports"],factory)}else if(typeof exports!=="undefined"){factory(exports)}else{var mod={exports:{}};factory(mod.exports);global.JSONEx=mod.exports}})(this,function(exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _classCallCheck(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(a,b){if(!a){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return b&&(typeof b==="object"||typeof b==="function")?b:a}function _inherits(a,b){if(typeof b!=="function"&&b!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof b)}a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:false,writable:true,configurable:true}});if(b)Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b}var JONExParseError=function(a){_inherits(b,a);function b(a){_classCallCheck(this,b);var c=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));c.type="JONExParseError";return c}return b}(Error);var text="";var currentPos=0;var stack=[];var beginWord=0;var stablePos=0;var __nativeJson=null;var __nativeReplaced=false;var __internal={isLetter:function b(a){return a.match(/[A-Za-z]/)},isDigit:function b(a){return a.match(/[0-9]/)},isWhitespace:function b(a){return a.match(/\s/)},isNewline:function b(a){return a.match(/\n/)},insert:function c(a,b){text=text.slice(0,currentPos)+a+text.slice(currentPos);if(b){currentPos+=b}},replace:function c(a,b){text=text.slice(0,currentPos)+a+text.slice(currentPos+1);if(b){currentPos+=b}},insertAtWord:function b(a){text=text.slice(0,beginWord)+a+text.slice(beginWord)},remove:function a(){text=text.slice(0,currentPos)+text.slice(currentPos+1);currentPos--},removePreviousComma:function a(){if(text[currentPos-1]===","){text=text.slice(0,currentPos-1)+text.slice(currentPos);currentPos--}},removeSpace:function c(){var a=text.length;while(currentPos<a&&__internal.isWhitespace(text[currentPos])){currentPos++}var b=text[currentPos];stablePos=currentPos;return b},pass:function c(a){var b=currentPos;while(a.indexOf(text[b])>=0){b++}currentPos=b;stablePos=currentPos;return text[b]},push:function b(a){stack.push(a);stablePos=currentPos},pop:function a(){stack.pop();stablePos=currentPos},check:function e(a,b,c){beginWord=currentPos;if(text.substr(currentPos,a.length)===a){var d=text[currentPos+a.length];if(d===","||d==="}"||d==="]"||d===" "){currentPos+=a.length-1;return b}currentPos--;return c}return c},next:function c(a){var b=text.length;while(currentPos<b&&a.indexOf(text[currentPos])===-1){currentPos++}return text[currentPos]},insertAtEndWordPos:function c(a){var b=currentPos-1;while(b>=0&&__internal.isWhitespace(text[b])){b--}b++;text=text.slice(0,b)+a+text.slice(b);currentPos++},lexical:function d(a,b){var c=stack[stack.length-1];switch(a){case"start":b=__internal.removeSpace();if(b==="{"){__internal.push("obj");return"obj_awaiting_key"}break;case"obj_awaiting_key":b=__internal.removeSpace();if(b==="}"){__internal.removePreviousComma();__internal.pop();return"obj_complete"}if(b==="\""){return"obj_key_str"}if(b==="'"){__internal.replace("\"");return"obj_key_str_incorrect_quotes"}if(__internal.isLetter(b)||__internal.isDigit(b)||b==="-"){__internal.insert("\"",1);return"obj_key_str_missing_left_quote"}break;case"obj_key_str_missing_left_quote":b=__internal.next(":\"'");if(b===":"){stablePos=currentPos;__internal.insertAtEndWordPos("\"");return"obj_awaiting_value"}if(b==="\""){return"obj_awaiting_colon"}if(b==="'"){__internal.replace("\"",1);currentPos--;return"obj_awaiting_colon"}break;case"obj_key_str_incorrect_quotes":if(b==="'"){__internal.replace("\"");return"obj_awaiting_colon"}break;case"obj_key_str":if(b==="\""){return"obj_awaiting_colon"}break;case"obj_awaiting_colon":if(b===":"){stablePos=currentPos;return"obj_awaiting_value"}break;case"obj_awaiting_value":b=__internal.removeSpace();if(b==="'"){__internal.replace("\"");return"obj_value_str_incorrect_quotes"}if(b==="{"){__internal.push("obj");return"obj_awaiting_key"}if(b==="["){__internal.push("arr");return"arr_stable"}if(b==="\""){return"obj_value_str"}if(__internal.isDigit(b)){return"obj_value_num"}if(b==="-"){return"obj_value_num"}if(b==="t"){return __internal.check("true","obj_stable","obj_missing_left_quote")}if(b==="f"){return __internal.check("false","obj_stable","obj_missing_left_quote")}if(b==="n"){return __internal.check("null","obj_stable","obj_missing_left_quote")}break;case"obj_missing_left_quote":__internal.insertAtWord("\"");return"obj_value_str_incorrect_quotes";case"obj_value_str":b=__internal.next("\"}");if(b==="\""){return"obj_stable"}if(b==="}"){__internal.insert("\"");__internal.pop();if(c==="obj"){return"obj_complete"}return"obj_stable"}break;case"obj_value_str_incorrect_quotes":b=__internal.next("',}");if(b==="'"){__internal.replace("\"");return"obj_stable"}if(b===","){__internal.insert("\"");return"obj_stable"}if(b==="}"){__internal.replace("\"}");__internal.pop();return"obj_complete"}break;case"obj_value_num":b=__internal.pass("0123456789.");b=__internal.removeSpace();if(b==="}"){__internal.pop();return"obj_complete"}if(b===","){return"obj_awaiting_key"}return"obj_value_num_error";case"obj_stable":stablePos=currentPos;b=__internal.next("},");if(b==="}"){__internal.pop();return"obj_complete"}if(b===","){return"obj_awaiting_key"}break;case"obj_complete":stablePos=currentPos;if(b==="]"){__internal.pop();return"arr_complete"}if(__internal.isNewline(b)){__internal.replace(",");if(c==="obj"){return"obj_awaiting_key"}return"arr_awaiting_value"}if(b===","){if(c==="obj"){return"obj_awaiting_key"}return"arr_awaiting_value"}break;case"arr_stable":stablePos=currentPos;if(__internal.isWhitespace(b)){__internal.remove()}if(b==="'"){__internal.replace("\"");return"arr_value_str_incorrect_quotes"}if(b==="{"){__internal.push("obj");return"obj_awaiting_key"}if(b==="["){__internal.push("arr");return"arr_stable"}if(b==="]"){__internal.pop();return"arr_complete"}if(b==="\""){return"arr_value_str"}if(__internal.isDigit(b)){return"arr_value_num"}if(b==="-"){return"arr_value_num"}if(b==="t"){return __internal.check("true","arr_stable","arr_error")}if(b==="f"){return __internal.check("false","arr_stable","arr_error")}if(b==="n"){return __internal.check("null","arr_stable","arr_error")}break;case"arr_awaiting_value":b=__internal.removeSpace();if(b==="'"){__internal.replace("\"");return"arr_value_str_incorrect_quotes"}if(b==="{"){__internal.push("obj");return"obj_awaiting_key"}if(b==="["){__internal.push("arr");return"arr_stable"}if(b==="]"){__internal.removePreviousComma();__internal.pop();return"arr_complete"}if(b==="\""){return"arr_value_str"}if(__internal.isDigit(b)){return"arr_value_num"}if(b==="-"){return"arr_value_num"}if(b==="t"){return __internal.check("true","arr_stable","arr_error")}if(b==="f"){return __internal.check("false","arr_stable","arr_error")}if(b==="n"){return __internal.check("null","arr_stable","arr_error")}break;case"arr_complete":stablePos=currentPos;if(b==="}"){__internal.pop();return"obj_complete"}if(__internal.isNewline(b)){if(c==="obj"){return"obj_awaiting_key"}return"arr_awaiting_value"}if(b===","){if(c==="obj"){return"obj_awaiting_key"}return"arr_awaiting_value"}break;case"arr_value_str":if(b==="\""){return"arr_stable"}break;case"arr_value_str_incorrect_quotes":if(b==="'"){__internal.replace("\"");return"arr_stable"}break;case"arr_value_num":b=__internal.pass("0123456789.");b=__internal.removeSpace();if(b==="]"){__internal.pop();return"arr_complete"}if(b===","){return"arr_awaiting_value"}break;default:break;}return a},error:function h(a,b){var c=20;var d=a.message.match(/^Unexpected token.*position\s+(\d+)/i);var e=d?Number(d[1]):a.message.match(/^Unexpected end of JSON.*/i)?b.length-1:null;var f=a.message;if(e!==null){var i=e<=c?0:e-c;var j=e+c>=b.length?b.length:e+c;var g=b.slice(i,j);f+=" while parsing near \n"+g+"\n"+"-".repeat(e)+"^"}else{f+=" while parsing "+b.slice(0,c*2)}return f}};function correct(a){var b="start";stack=[];text=a;currentPos=0;var c="";while(currentPos<text.length){c=text[currentPos];b=__internal.lexical(b,c);currentPos++}if(b!=="obj_complete"){var d=stablePos-20<0?0:stablePos-20;var e=stablePos+20>=text.length?text.length:stablePos+20;var f=text.substring(d,e)+"\n"+"-".repeat(20)+"^";throw new JONExParseError("Error: Second chance: parse error at position "+currentPos+" with state "+b+" after \n"+f)}return text}function parse(a){try{return __nativeJson.parse(a)}catch(d){try{var b=correct(a);return __nativeJson.parse(b)}catch(e){var c=__internal.error(d,a)+"\n";if(e.type==="JONExParseError"){c+=e.message}else{c+=__internal.error(e,b||"")}throw new JONExParseError(c)}}}function replaceNativeJson(){if(!__nativeReplaced){__nativeJson=JSON;__nativeReplaced=true;JSON=this}}function revertToNativeJson(){if(__nativeReplaced){JSON=__nativeJson;__nativeReplaced=false}}function stringify(a){return __nativeJson.stringify(a)}__nativeJson=JSON;exports.parse=parse;exports.correct=correct;exports.stringify=stringify;exports.revertToNativeJson=revertToNativeJson;exports.replaceNativeJson=replaceNativeJson});